<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .market-status {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab.active {
            background: white;
            color: #333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        input, select, button {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .search-box {
            position: relative;
            min-width: 200px;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .suggestion-item:hover {
            background: #f8f9fa;
        }

        .data-grid {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .neutral {
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sector-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .sector-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }

        .sector-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .sector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sector-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
        }

        .sector-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }

        .mock-trade-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .trade-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .result-value {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .result-label {
            font-size: 0.9rem;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-bar {
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: scaleY(1.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“ˆ Stock Analysis Dashboard</h1>
            <div class="market-status" id="marketStatus">
                Loading market status...
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('stock-analysis')">Stock Analysis</button>
            <button class="tab" onclick="switchTab('historical-data')">Historical Data</button>
            <button class="tab" onclick="switchTab('realtime-data')">Real-time Data</button>
            <button class="tab" onclick="switchTab('sector-analysis')">Sector Analysis</button>
            <button class="tab" onclick="switchTab('mock-trade')">Mock Trade</button>
        </div>

        <!-- Stock Analysis Tab -->
        <div id="stock-analysis" class="tab-content active">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="stockSearch" placeholder="Search stocks, companies, or sectors..." onkeyup="searchStocks(this.value)">
                    <div class="search-suggestions" id="searchSuggestions"></div>
                </div>
                <button onclick="loadStockAnalysis()">Refresh Data</button>
                <button onclick="clearSearch()">Show All</button>
            </div>
            <div id="stockAnalysisContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading stock analysis data...</p>
                </div>
            </div>
        </div>

        <!-- Historical Data Tab -->
        <div id="historical-data" class="tab-content">
            <div class="controls">
                <div class="form-group">
                    <label for="historicalDate">Select Date:</label>
                    <input type="date" id="historicalDate" value="">
                </div>
                <button onclick="loadHistoricalData()">Load Historical Data</button>
            </div>
            <div id="historicalDataContent">
                <p>Select a date to view historical stock data.</p>
            </div>
        </div>

        <!-- Real-time Data Tab -->
        <div id="realtime-data" class="tab-content">
            <div class="controls">
                <div class="form-group">
                    <label for="realtimeDate">Date:</label>
                    <input type="date" id="realtimeDate" value="">
                </div>
                <div class="form-group">
                    <label for="realtimeTime">Time (HH:MM):</label>
                    <input type="time" id="realtimeTime" value="" min="09:15" max="15:30">
                </div>
                <button onclick="loadRealtimeData()">Load Real-time Data</button>
                <button onclick="setCurrentTime()">Use Current Time</button>
            </div>
            <div id="realtimeDataContent">
                <p>Select date and time to view real-time stock data.</p>
            </div>
        </div>

        <!-- Sector Analysis Tab -->
        <div id="sector-analysis" class="tab-content">
            <div class="controls">
                <button onclick="loadSectorAnalysis()">Refresh Sector Data</button>
            </div>
            <div id="sectorAnalysisContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading sector analysis data...</p>
                </div>
            </div>
        </div>

        <!-- Mock Trade Tab -->
        <div id="mock-trade" class="tab-content">
            <div class="mock-trade-form">
                <h3>Mock Trade Analysis</h3>
                <div class="controls">
                    <div class="form-group">
                        <label for="tradeTicker">Ticker Symbol:</label>
                        <input type="text" id="tradeTicker" placeholder="e.g., RELIANCE.NS" list="tickerList">
                        <datalist id="tickerList"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="tradeDate">Trade Date:</label>
                        <input type="date" id="tradeDate" value="">
                    </div>
                    <div class="form-group">
                        <label for="tradeTime">Entry Time:</label>
                        <input type="time" id="tradeTime" value="09:15" min="09:15" max="15:30">
                    </div>
                    <div class="form-group">
                        <label for="investmentAmount">Investment Amount (â‚¹):</label>
                        <input type="number" id="investmentAmount" value="10000" min="1000" step="1000">
                    </div>
                    <button onclick="executeMockTrade()">Execute Mock Trade</button>
                </div>
            </div>
            <div id="mockTradeResults"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = null;
        let tickersList = [];
        const API_BASE = const API_BASE = window.location.origin + '/api';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadMarketStatus();
            loadStockAnalysis();
            loadSectorAnalysis();
            loadTickersList();
        });

        // Initialize default dates
        function initializeDates() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            document.getElementById('historicalDate').value = yesterdayStr;
            document.getElementById('realtimeDate').value = todayStr;
            document.getElementById('tradeDate').value = yesterdayStr;
            
            // Set current time for real-time tab
            const now = new Date();
            const timeStr = now.toTimeString().slice(0, 5);
            document.getElementById('realtimeTime').value = timeStr;
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Load market status
        async function loadMarketStatus() {
            try {
                const response = await fetch(`${API_BASE}/market-status`);
                const data = await response.json();
                
                const statusElement = document.getElementById('marketStatus');
                const statusClass = data.is_market_open ? 'positive' : 'neutral';
                statusElement.innerHTML = `
                    <span class="${statusClass}">
                        ${data.market_session} | ${data.current_time}
                    </span>
                `;
            } catch (error) {
                console.error('Error loading market status:', error);
                document.getElementById('marketStatus').innerHTML = 'Market status unavailable';
            }
        }

        // Load stock analysis data
        async function loadStockAnalysis() {
            const contentDiv = document.getElementById('stockAnalysisContent');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading stock analysis data...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/data`);
                const data = await response.json();
                currentData = data;
                
                let messageHtml = '';
                if (data.message) {
                    messageHtml = `<div class="success-message">${data.message}</div>`;
                }
                
                renderStockTable(data.stocks, messageHtml);
            } catch (error) {
                console.error('Error loading stock data:', error);
                contentDiv.innerHTML = '<div class="error-message">Error loading stock data. Please try again.</div>';
            }
        }

        // Search stocks
        async function searchStocks(query) {
            if (!query || query.length < 2) {
                document.getElementById('searchSuggestions').style.display = 'none';
                if (currentData) {
                    renderStockTable(currentData.stocks);
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                renderSearchSuggestions(data.results);
                renderStockTable(data.results);
            } catch (error) {
                console.error('Error searching stocks:', error);
            }
        }

        // Render search suggestions
        function renderSearchSuggestions(results) {
            const suggestionsDiv = document.getElementById('searchSuggestions');
            
            if (results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            const suggestionsList = results.slice(0, 5).map(stock => `
                <div class="suggestion-item" onclick="selectSuggestion('${stock.ticker}', '${stock.company_name}')">
                    <strong>${stock.ticker}</strong> - ${stock.company_name}
                </div>
            `).join('');
            
            suggestionsDiv.innerHTML = suggestionsList;
            suggestionsDiv.style.display = 'block';
        }

        // Select suggestion
        function selectSuggestion(ticker, companyName) {
            document.getElementById('stockSearch').value = `${ticker} - ${companyName}`;
            document.getElementById('searchSuggestions').style.display = 'none';
        }

        // Clear search
        function clearSearch() {
            document.getElementById('stockSearch').value = '';
            document.getElementById('searchSuggestions').style.display = 'none';
            if (currentData) {
                renderStockTable(currentData.stocks);
            }
        }

        // Render stock table
        function renderStockTable(stocks, messageHtml = '') {
            const contentDiv = document.getElementById('stockAnalysisContent');
            
            if (!stocks || stocks.length === 0) {
                contentDiv.innerHTML = messageHtml + '<div class="error-message">No stock data available.</div>';
                return;
            }
            
            const table = `
                ${messageHtml}
                <div class="data-grid">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>Sector</th>
                                <th>9:15 AM</th>
                                <th>9:19 AM</th>
                                <th>Morning Change</th>
                                <th>3:15 PM (Prev)</th>
                                <th>3:29 PM (Prev)</th>
                                <th>Closing Change</th>
                                <th>Open Price</th>
                                <th>Prev Close</th>
                                <th>Current Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map(stock => {
                                if (stock.error) {
                                    return `
                                        <tr>
                                            <td>${stock.ticker}</td>
                                            <td colspan="11" class="error-message">${stock.error}</td>
                                        </tr>
                                    `;
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${stock.ticker}</strong></td>
                                        <td>${stock.company_name || 'N/A'}</td>
                                        <td>${stock.sector || 'N/A'}</td>
                                        <td>â‚¹${stock.p915 || 'N/A'}</td>
                                        <td>â‚¹${stock.p919 || 'N/A'}</td>
                                        <td class="${getChangeClass(stock.morning_change)}">
                                            ${stock.morning_change ? stock.morning_change.toFixed(2) + '%' : 'N/A'}
                                        </td>
                                        <td>â‚¹${stock.p315 || 'N/A'}</td>
                                        <td>â‚¹${stock.p329 || 'N/A'}</td>
                                        <td class="${getChangeClass(stock.closing_change)}">
                                            ${stock.closing_change ? stock.closing_change.toFixed(2) + '%' : 'N/A'}
                                        </td>
                                        <td>â‚¹${stock.open_price || 'N/A'}</td>
                                        <td>â‚¹${stock.prev_day_close || 'N/A'}</td>
                                        <td>â‚¹${stock.current_price || 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            contentDiv.innerHTML = table;
        }

        // Load historical data
        async function loadHistoricalData() {
            const date = document.getElementById('historicalDate').value;
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const contentDiv = document.getElementById('historicalDataContent');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading historical data...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/historical/${date}`);
                const data = await response.json();
                
                let messageHtml = '';
                if (data.date_adjusted) {
                    messageHtml = `<div class="success-message">${data.adjustment_reason}</div>`;
                }
                
                renderHistoricalTable(data.stocks, messageHtml);
            } catch (error) {
                console.error('Error loading historical data:', error);
                contentDiv.innerHTML = '<div class="error-message">Error loading historical data. Please try again.</div>';
            }
        }

        // Render historical table
        function renderHistoricalTable(stocks, messageHtml = '') {
            const contentDiv = document.getElementById('historicalDataContent');
            
            if (!stocks || stocks.length === 0) {
                contentDiv.innerHTML = messageHtml + '<div class="error-message">No historical data available for the selected date.</div>';
                return;
            }
            
            const table = `
                ${messageHtml}
                <div class="data-grid">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>Sector</th>
                                <th>9:15 AM</th>
                                <th>9:19 AM</th>
                                <th>Morning Change</th>
                                <th>Volume (9:15)</th>
                                <th>Volume (9:19)</th>
                                <th>Volume Change</th>
                                <th>Open Price</th>
                                <th>Prev Close</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map(stock => {
                                if (stock.error) {
                                    return `
                                        <tr>
                                            <td>${stock.ticker}</td>
                                            <td colspan="10" class="error-message">${stock.error}</td>
                                        </tr>
                                    `;
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${stock.ticker}</strong></td>
                                        <td>${stock.company_name || 'N/A'}</td>
                                        <td>${stock.sector || 'N/A'}</td>
                                        <td>â‚¹${stock.p915 || 'N/A'}</td>
                                        <td>â‚¹${stock.p919 || 'N/A'}</td>
                                        <td class="${getChangeClass(stock.morning_change)}">
                                            ${stock.morning_change ? stock.morning_change.toFixed(2) + '%' : 'N/A'}
                                        </td>
                                        <td>${stock.v915 ? formatNumber(stock.v915) : 'N/A'}</td>
                                        <td>${stock.v919 ? formatNumber(stock.v919) : 'N/A'}</td>
                                        <td class="${getChangeClass(stock.morning_volume_change)}">
                                            ${stock.morning_volume_change ? stock.morning_volume_change.toFixed(2) + '%' : 'N/A'}
                                        </td>
                                        <td>â‚¹${stock.open_price || 'N/A'}</td>
                                        <td>â‚¹${stock.prev_day_close || 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            contentDiv.innerHTML = table;
        }

        // Set current time
        function setCurrentTime() {
            const now = new Date();
            const timeStr = now.toTimeString().slice(0, 5);
            document.getElementById('realtimeTime').value = timeStr;
            
            const todayStr = now.toISOString().split('T')[0];
            document.getElementById('realtimeDate').value = todayStr;
        }

        // Load real-time data
        async function loadRealtimeData() {
            const date = document.getElementById('realtimeDate').value;
            const time = document.getElementById('realtimeTime').value;
            
            if (!date || !time) {
                alert('Please select both date and time');
                return;
            }
            
            const contentDiv = document.getElementById('realtimeDataContent');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading real-time data...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/data/time-filtered?date=${date}&time=${time}`);
                const data = await response.json();
                
                let messageHtml = '';
                if (data.date_adjusted) {
                    messageHtml = `<div class="success-message">${data.adjustment_reason}</div>`;
                }
                
                renderRealtimeTable(data.stocks, messageHtml);
            } catch (error) {
                console.error('Error loading real-time data:', error);
                contentDiv.innerHTML = '<div class="error-message">Error loading real-time data. Please try again.</div>';
            }
        }

        // Render real-time table
        function renderRealtimeTable(stocks, messageHtml = '') {
            const contentDiv = document.getElementById('realtimeDataContent');
            
            if (!stocks || stocks.length === 0) {
                contentDiv.innerHTML = messageHtml + '<div class="error-message">No real-time data available for the selected time range.</div>';
                return;
            }
            
            const table = `
                ${messageHtml}
                <div class="data-grid">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>Sector</th>
                                <th>Opening Price</th>
                                <th>Current Price</th>
                                <th>High</th>
                                <th>Low</th>
                                <th>Intraday Change</th>
                                <th>Overall Change</th>
                                <th>Total Volume</th>
                                <th>Data Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map(stock => {
                                if (stock.error) {
                                    return `
                                        <tr>
                                            <td>${stock.ticker}</td>
                                            <td colspan="10" class="error-message">${stock.error}</td>
                                        </tr>
                                    `;
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${stock.ticker}</strong></td>
                                        <td>${stock.company_name || 'N/A'}</td>
                                        <td>${stock.sector || 'N/A'}</td>
                                        <td>â‚¹${stock.opening_price || 'N/A'}</td>
                                        <td>â‚¹${stock.current_price || 'N/A'}</td>
                                        <td>â‚¹${stock.high_price || 'N/A'}</td>
                                        <td>â‚¹${stock.low_price || 'N/A'}</td>
                                        <td class="${getChangeClass(stock.intraday_change)}">
                                            ${stock.intraday_change ? stock.intraday_change.toFixed(2) + '%' : 'N/A'}
                                        </td>
                                        <td class="${getChangeClass(stock.overall_change)}">
                                            ${stock.overall_change ? stock.overall_change.toFixed(2) + '%' : 'N/A'}
                                        </td>
                                        <td>${stock.total_volume ? formatNumber(stock.total_volume) : 'N/A'}</td>
                                        <td>${stock.data_points || 'N/A'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            contentDiv.innerHTML = table;
        }

        // Load sector analysis
        async function loadSectorAnalysis() {
            const contentDiv = document.getElementById('sectorAnalysisContent');
            contentDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading sector analysis data...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/sectors`);
                const data = await response.json();
                
                let messageHtml = '';
                if (data.message) {
                    messageHtml = `<div class="success-message">${data.message}</div>`;
                }
                
                renderSectorCards(data.sectors, messageHtml);
            } catch (error) {
                console.error('Error loading sector data:', error);
                contentDiv.innerHTML = '<div class="error-message">Error loading sector data. Please try again.</div>';
            }
        }

        // Render sector cards
        function renderSectorCards(sectors, messageHtml = '') {
            const contentDiv = document.getElementById('sectorAnalysisContent');
            
            if (!sectors || sectors.length === 0) {
                contentDiv.innerHTML = messageHtml + '<div class="error-message">No sector data available.</div>';
                return;
            }
            
            const cards = sectors.map(sector => `
                <div class="sector-card">
                    <div class="sector-header">
                        <div class="sector-name">${sector.sector}</div>
                        <div class="stat-value ${getChangeClass(sector.avg_morning_change)}">
                            ${sector.avg_morning_change ? sector.avg_morning_change.toFixed(2) + '%' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="sector-stats">
                        <div class="stat-item">
                            <div class="stat-value">${sector.total_stocks}</div>
                            <div class="stat-label">Total Stocks</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value positive">${sector.gainers}</div>
                            <div class="stat-label">Gainers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value negative">${sector.losers}</div>
                            <div class="stat-label">Losers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value ${getChangeClass(sector.avg_closing_change)}">
                                ${sector.avg_closing_change ? sector.avg_closing_change.toFixed(2) + '%' : 'N/A'}
                            </div>
                            <div class="stat-label">Avg Closing Change</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <strong>Morning Session:</strong>
                        <span class="positive">â†‘${sector.morning_gainers}</span> |
                        <span class="negative">â†“${sector.morning_losers}</span>
                    </div>
                    <div style="margin-top: 5px;">
                        <strong>Previous Closing:</strong>
                        <span class="positive">â†‘${sector.closing_gainers}</span> |
                        <span class="negative">â†“${sector.closing_losers}</span>
                    </div>
                </div>
            `).join('');
            
            contentDiv.innerHTML = messageHtml + `<div class="sector-cards">${cards}</div>`;
        }

        // Load tickers list for mock trade
        async function loadTickersList() {
            try {
                const response = await fetch(`${API_BASE}/tickers`);
                const data = await response.json();
                
                const datalist = document.getElementById('tickerList');
                datalist.innerHTML = Object.keys(data.tickers).map(ticker => 
                    `<option value="${ticker}">${data.tickers[ticker].company}</option>`
                ).join('');
                
                tickersList = data.tickers;
            } catch (error) {
                console.error('Error loading tickers list:', error);
            }
        }

        // Execute mock trade
        async function executeMockTrade() {
            const ticker = document.getElementById('tradeTicker').value;
            const date = document.getElementById('tradeDate').value;
            const time = document.getElementById('tradeTime').value;
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value);
            
            if (!ticker || !date || !time || !investmentAmount) {
                alert('Please fill in all fields');
                return;
            }
            
            const resultsDiv = document.getElementById('mockTradeResults');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Executing mock trade...</p></div>';
            
            try {
                const response = await fetch(`${API_BASE}/mock-trade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        date: date,
                        time: time,
                        investment_amount: investmentAmount
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error-message">${data.error}</div>`;
                    return;
                }
                
                renderMockTradeResults(data);
            } catch (error) {
                console.error('Error executing mock trade:', error);
                resultsDiv.innerHTML = '<div class="error-message">Error executing mock trade. Please try again.</div>';
            }
        }

        // Render mock trade results
        function renderMockTradeResults(data) {
            const resultsDiv = document.getElementById('mockTradeResults');
            
            const profitClass = data.max_profit >= 0 ? 'positive' : 'negative';
            const returnClass = data.return_percentage >= 0 ? 'positive' : 'negative';
            
            let dateAdjustmentMessage = '';
            if (data.date_adjusted) {
                dateAdjustmentMessage = `<div class="success-message">${data.adjustment_reason}</div>`;
            }
            
            const results = `
                <h3>Mock Trade Results for ${data.ticker}</h3>
                
                ${dateAdjustmentMessage}
                
                <div class="trade-results">
                    <div class="result-card">
                        <div class="result-value">${data.company_name}</div>
                        <div class="result-label">Company</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value">${data.sector}</div>
                        <div class="result-label">Sector</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value">â‚¹${data.investment_amount.toLocaleString()}</div>
                        <div class="result-label">Investment Amount</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value">${data.shares_bought}</div>
                        <div class="result-label">Shares Bought</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value">â‚¹${data.entry_price}</div>
                        <div class="result-label">Entry Price (${data.entry_time})</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value">â‚¹${data.exit_price}</div>
                        <div class="result-label">Best Exit Price (${data.best_exit_time})</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value ${profitClass}">â‚¹${data.max_profit.toLocaleString()}</div>
                        <div class="result-label">Maximum Profit</div>
                    </div>
                    <div class="result-card">
                        <div class="result-value ${returnClass}">${data.return_percentage.toFixed(2)}%</div>
                        <div class="result-label">Return Percentage</div>
                    </div>
                </div>
                
                ${renderPriceChart(data.minute_prices)}
            `;
            
            resultsDiv.innerHTML = results;
        }

        // Render price chart for mock trade
        function renderPriceChart(minutePrices) {
            if (!minutePrices || minutePrices.length === 0) {
                return '<p>No minute-by-minute data available for chart.</p>';
            }
            
            const maxProfit = Math.max(...minutePrices.map(p => p.profit));
            const minProfit = Math.min(...minutePrices.map(p => p.profit));
            const range = maxProfit - minProfit || 1;
            
            const chartData = minutePrices.map((point, index) => {
                const height = Math.max(5, ((point.profit - minProfit) / range) * 100);
                const color = point.profit >= 0 ? '#28a745' : '#dc3545';
                
                return `
                    <div class="chart-bar" 
                         style="height: ${height}%; background-color: ${color}; width: ${90/minutePrices.length}%; display: inline-block; margin-right: 1px; border-radius: 2px;" 
                         title="${point.time}: â‚¹${point.price}, Profit: â‚¹${point.profit.toFixed(2)}">
                    </div>
                `;
            }).join('');
            
            return `
                <div class="chart-container">
                    <h4>Profit/Loss Chart (Minute-by-Minute)</h4>
                    <div style="height: 200px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; position: relative; display: flex; align-items: end;">
                        <div style="position: absolute; left: 0; top: 50%; width: 100%; height: 1px; background: #ccc; z-index: 1;"></div>
                        <div style="height: 100%; width: 100%; position: relative; z-index: 2; display: flex; align-items: end; justify-content: space-between;">
                            ${chartData}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <strong>Max Profit:</strong> <span class="positive">â‚¹${maxProfit.toFixed(2)}</span> |
                        <strong>Min Profit:</strong> <span class="negative">â‚¹${minProfit.toFixed(2)}</span> |
                        <strong>Data Points:</strong> ${minutePrices.length}
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h5>Detailed Price Movement</h5>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                            <table style="width: 100%; font-size: 0.8rem;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 5px; text-align: left;">Time</th>
                                        <th style="padding: 5px; text-align: right;">Price</th>
                                        <th style="padding: 5px; text-align: right;">Profit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${minutePrices.map(point => `
                                        <tr>
                                            <td style="padding: 3px 5px;">${point.time}</td>
                                            <td style="padding: 3px 5px; text-align: right;">â‚¹${point.price}</td>
                                            <td style="padding: 3px 5px; text-align: right;" class="${getChangeClass(point.profit)}">
                                                â‚¹${point.profit.toFixed(2)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function getChangeClass(value) {
            if (value === null || value === undefined) return 'neutral';
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }

        function formatNumber(num) {
            if (num >= 10000000) {
                return (num / 10000000).toFixed(1) + 'Cr';
            } else if (num >= 100000) {
                return (num / 100000).toFixed(1) + 'L';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Auto-refresh functionality
        setInterval(() => {
            loadMarketStatus();
        }, 60000); // Refresh market status every minute

        // Hide search suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.search-box')) {
                document.getElementById('searchSuggestions').style.display = 'none';
            }
        });

        // Keyboard navigation for search
        document.getElementById('stockSearch').addEventListener('keydown', function(event) {
            const suggestions = document.getElementById('searchSuggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            if (event.key === 'Escape') {
                suggestions.style.display = 'none';
            } else if (event.key === 'Enter' && items.length > 0) {
                items[0].click();
                event.preventDefault();
            }
        });

        // Auto-complete for ticker input in mock trade
        document.getElementById('tradeTicker').addEventListener('input', function(event) {
            const value = event.target.value.toUpperCase();
            const matchingTickers = Object.keys(tickersList).filter(ticker => 
                ticker.includes(value) || tickersList[ticker].company.toUpperCase().includes(value)
            );
            
            const datalist = document.getElementById('tickerList');
            datalist.innerHTML = matchingTickers.slice(0, 10).map(ticker => 
                `<option value="${ticker}">${tickersList[ticker].company}</option>`
            ).join('');
        });

        // Add debounce to search function to improve performance
        let searchTimeout;
        const originalSearchStocks = searchStocks;
        searchStocks = function(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                originalSearchStocks(query);
            }, 300);
        };

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        switchTab('stock-analysis');
                        break;
                    case '2':
                        event.preventDefault();
                        switchTab('historical-data');
                        break;
                    case '3':
                        event.preventDefault();
                        switchTab('realtime-data');
                        break;
                    case '4':
                        event.preventDefault();
                        switchTab('sector-analysis');
                        break;
                    case '5':
                        event.preventDefault();
                        switchTab('mock-trade');
                        break;
                    case 'r':
                        event.preventDefault();
                        const activeTab = document.querySelector('.tab.active').onclick.toString().match(/switchTab\('([^']+)'\)/)[1];
                        switch(activeTab) {
                            case 'stock-analysis':
                                loadStockAnalysis();
                                break;
                            case 'historical-data':
                                loadHistoricalData();
                                break;
                            case 'realtime-data':
                                loadRealtimeData();
                                break;
                            case 'sector-analysis':
                                loadSectorAnalysis();
                                break;
                        }
                        break;
                }
            }
        });

        // Add tooltip for keyboard shortcuts
        const keyboardShortcuts = `
            <div style="position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 8px; font-size: 0.8rem; max-width: 200px; display: none;" id="shortcutsTooltip">
                <strong>Keyboard Shortcuts:</strong><br>
                Ctrl+1-5: Switch tabs<br>
                Ctrl+R: Refresh current tab<br>
                Esc: Close search suggestions
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', keyboardShortcuts);

        // Show/hide shortcuts tooltip
        let shortcutsVisible = false;
        document.addEventListener('keydown', function(event) {
            if (event.key === 'F1') {
                event.preventDefault();
                const tooltip = document.getElementById('shortcutsTooltip');
                shortcutsVisible = !shortcutsVisible;
                tooltip.style.display = shortcutsVisible ? 'block' : 'none';
            }
        });

        // Error retry functionality
        function addRetryButton(contentDiv, retryFunction) {
            const retryButton = '<button onclick="' + retryFunction + '()" style="margin-top: 10px;">Retry</button>';
            contentDiv.innerHTML += retryButton;
        }

        // Enhanced error handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // You could show a global error message here
        });

        // Performance monitoring
        const performanceMonitor = {
            startTime: null,
            endTime: null,
            
            start: function() {
                this.startTime = performance.now();
            },
            
            end: function(operation) {
                this.endTime = performance.now();
                const duration = this.endTime - this.startTime;
                console.log(`${operation} took ${duration.toFixed(2)} milliseconds`);
                
                // Show performance warning if operation takes too long
                if (duration > 5000) {
                    console.warn(`${operation} is taking longer than expected (${duration.toFixed(2)}ms)`);
                }
            }
        };

        // Add loading performance monitoring to major functions
        const originalLoadStockAnalysis = loadStockAnalysis;
        loadStockAnalysis = async function() {
            performanceMonitor.start();
            await originalLoadStockAnalysis();
            performanceMonitor.end('Stock Analysis Load');
        };

        console.log('ðŸš€ Stock Analysis Dashboard loaded successfully!');
        console.log('ðŸ’¡ Press F1 to see keyboard shortcuts');
    </script>
</body>
</html>
