<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>F&O Stock Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f6f9;
        }
        h1 {
            text-align: center;
        }
        #info {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .tabs {
            text-align: center;
            margin-bottom: 10px;
        }
        .tabs button {
            margin: 0 5px;
            padding: 10px 20px;
            cursor: pointer;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #333;
            color: white;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .gain {
            background-color: #d4edda;
        }
        .loss {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <h1>F&O Stock Analyzer</h1>
    <div class="tabs">
        <button onclick="loadData('analyze')">All Stocks</button>
        <button onclick="loadData('gainers')">Unique Gainers</button>
    </div>
    <div id="info"></div>
    <table id="stock-table">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Prev Close</th>
                <th>Today Open</th>
                <th>Current Price</th>
                <th>3:15 PM</th>
                <th>3:29 PM</th>
                <th>% Change (3:15–3:29 PM)</th>
                <th>9:15 AM</th>
                <th>9:19 AM</th>
                <th>% Change (9:15–9:19 AM)</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <tr><td colspan="10">Click "All Stocks" or "Unique Gainers" to begin analysis.</td></tr>
        </tbody>
    </table>

    <script>
        async function loadData(endpoint) {
            const res = await fetch(`/${endpoint}`);
            const data = await res.json();
            const tbody = document.getElementById("table-body");
            tbody.innerHTML = "";

            if (!data.length) {
                tbody.innerHTML = "<tr><td colspan='10'>No data found</td></tr>";
                return;
            }

            // Extract the dates once from the first entry
            const morningDate = data[0].morning_date;
            const closingDate = data[0].closing_date;
            document.getElementById("info").innerText = 
                `Morning Session Date: ${morningDate} | Closing Session Date: ${closingDate}`;

            data.forEach(d => {
                const row = document.createElement("tr");

                function cell(value, isPercent=false) {
                    const td = document.createElement("td");
                    td.textContent = value !== null ? (isPercent ? value + "%" : value) : "--";
                    return td;
                }

                row.appendChild(cell(d.ticker));
                row.appendChild(cell(d.prev_day_close));
                row.appendChild(cell(d.open_price));
                row.appendChild(cell(d.current_price));
                row.appendChild(cell(d.p315));
                row.appendChild(cell(d.p329));
                const cc = cell(d.closing_change, true);
                if (d.closing_change !== null) cc.className = d.closing_change > 0 ? "gain" : "loss";
                row.appendChild(cc);
                row.appendChild(cell(d.p915));
                row.appendChild(cell(d.p919));
                const mc = cell(d.morning_change, true);
                if (d.morning_change !== null) mc.className = d.morning_change > 0 ? "gain" : "loss";
                row.appendChild(mc);

                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
