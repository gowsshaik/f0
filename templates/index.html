<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        
        .nav-tabs { display: flex; background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 30px; overflow: hidden; backdrop-filter: blur(10px); }
        .nav-tab { flex: 1; padding: 15px 20px; text-align: center; color: white; cursor: pointer; transition: all 0.3s; border: none; background: none; font-size: 16px; }
        .nav-tab:hover { background: rgba(255,255,255,0.1); }
        .nav-tab.active { background: rgba(255,255,255,0.2); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        
        .stock-card { border-left: 5px solid #4CAF50; }
        .stock-card.negative { border-left-color: #f44336; }
        .stock-name { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; color: #333; }
        .company-name { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .sector-badge { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-bottom: 15px; }
        
        .price-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .price-section h4 { font-size: 0.9rem; color: #666; margin-bottom: 8px; }
        .price-value { font-size: 1.1rem; font-weight: bold; }
        .change-positive { color: #4CAF50; }
        .change-negative { color: #f44336; }
        
        .volume-info { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.9rem; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: white; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.9); }
        .btn { background: linear-gradient(45deg, #FF6B6B, #4ECDC4); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: transform 0.3s; }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .historical-form, .mock-trade-form { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        
        .result-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 20px; }
        
        .sector-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-item { text-align: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; }
        .stat-value { font-size: 2rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.9rem; opacity: 0.8; }
        
        .loading { text-align: center; color: white; font-size: 1.2rem; padding: 40px; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 8px; margin: 10px 0; }
        
        .chart-container { background: white; padding: 20px; border-radius: 15px; margin: 20px 0; height: 400px; }
        
        @media (max-width: 768px) {
            .nav-tabs { flex-direction: column; }
            .cards-grid { grid-template-columns: 1fr; }
            .price-info { grid-template-columns: 1fr; }
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 Stock Market Analysis Dashboard</h1>
            <p>Real-time Indian Stock Market Analysis & Mock Trading Platform</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('live')">Live Data</button>
            <button class="nav-tab" onclick="switchTab('historical')">Historical</button>
            <button class="nav-tab" onclick="switchTab('mock-trade')">Mock Trading</button>
            <button class="nav-tab" onclick="switchTab('sectors')">Sectors</button>
        </div>
        
        <div id="live-tab" class="tab-content active">
            <div id="live-data" class="cards-grid">
                <div class="loading">Loading live market data...</div>
            </div>
        </div>
        
        <div id="historical-tab" class="tab-content">
            <div class="historical-form">
                <h3 style="color: white; margin-bottom: 20px;">📊 Historical Analysis</h3>
                <div class="form-group">
                    <label>Stock Ticker:</label>
                    <select id="historical-ticker">
                        <option value="PVRINOX.NS">PVR INOX Ltd</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" id="historical-date" max="">
                </div>
                <button class="btn" onclick="fetchHistoricalData()">Analyze Historical Data</button>
            </div>
            <div id="historical-results"></div>
        </div>
        
        <div id="mock-trade-tab" class="tab-content">
            <div class="mock-trade-form">
                <h3 style="color: white; margin-bottom: 20px;">💰 Mock Trading Simulator</h3>
                <div class="form-group">
                    <label>Stock Ticker:</label>
                    <select id="trade-ticker">
                        <option value="PVRINOX.NS">PVR INOX Ltd</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Trading Date:</label>
                    <input type="date" id="trade-date" max="">
                </div>
                <div class="form-group">
                    <label>Entry Time (HH:MM):</label>
                    <input type="time" id="trade-time" value="09:30" min="09:15" max="15:30">
                </div>
                <div class="form-group">
                    <label>Investment Amount (₹):</label>
                    <input type="number" id="investment-amount" value="10000" min="100" step="100">
                </div>
                <button class="btn" onclick="executeMockTrade()">Execute Mock Trade</button>
            </div>
            <div id="mock-trade-results"></div>
        </div>
        
        <div id="sectors-tab" class="tab-content">
            <div id="sector-data">
                <div class="loading">Loading sector performance...</div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'live';
        let liveDataInterval;

        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            currentTab = tab;
            
            if (tab === 'live') {
                startLiveUpdates();
            } else {
                stopLiveUpdates();
            }
            
            if (tab === 'sectors') {
                fetchSectorData();
            }
        }

        function startLiveUpdates() {
            fetchLiveData();
            liveDataInterval = setInterval(fetchLiveData, 30000);
        }

        function stopLiveUpdates() {
            if (liveDataInterval) {
                clearInterval(liveDataInterval);
                liveDataInterval = null;
            }
        }

        async function fetchLiveData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                displayLiveData(data.stocks);
            } catch (error) {
                document.getElementById('live-data').innerHTML = 
                    `<div class="error">Error fetching live data: ${error.message}</div>`;
            }
        }

        function displayLiveData(stocks) {
            const container = document.getElementById('live-data');
            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<div class="error">No data available</div>';
                return;
            }

            container.innerHTML = stocks.map(stock => {
                if (stock.error) {
                    return `<div class="card"><div class="error">${stock.ticker}: ${stock.error}</div></div>`;
                }

                const morningChangeClass = stock.morning_change >= 0 ? 'change-positive' : 'change-negative';
                const closingChangeClass = stock.closing_change >= 0 ? 'change-positive' : 'change-negative';

                return `
                    <div class="card stock-card ${stock.morning_change < 0 ? 'negative' : ''}">
                        <div class="stock-name">${stock.ticker}</div>
                        <div class="company-name">${stock.company_name}</div>
                        <div class="sector-badge">${stock.sector}</div>
                        
                        <div class="price-info">
                            <div class="price-section">
                                <h4>📈 Morning Session (${stock.morning_date})</h4>
                                <div class="price-value">₹${stock.p915} → ₹${stock.p919}</div>
                                <div class="${morningChangeClass}">${stock.morning_change > 0 ? '+' : ''}${stock.morning_change}%</div>
                            </div>
                            <div class="price-section">
                                <h4>📉 Previous Closing (${stock.closing_date})</h4>
                                <div class="price-value">₹${stock.p315} → ₹${stock.p329}</div>
                                <div class="${closingChangeClass}">${stock.closing_change > 0 ? '+' : ''}${stock.closing_change}%</div>
                            </div>
                        </div>
                        
                        <div class="volume-info">
                            <strong>Volume Changes:</strong><br>
                            Morning: ${stock.morning_volume_change ? (stock.morning_volume_change > 0 ? '+' : '') + stock.morning_volume_change + '%' : 'N/A'} 
                            | Closing: ${stock.closing_volume_change ? (stock.closing_volume_change > 0 ? '+' : '') + stock.closing_volume_change + '%' : 'N/A'}
                        </div>
                        
                        ${stock.current_price ? `<div style="margin-top: 10px; font-weight: bold;">Current: ₹${stock.current_price}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function fetchHistoricalData() {
            const ticker = document.getElementById('historical-ticker').value;
            const date = document.getElementById('historical-date').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }

            const resultsContainer = document.getElementById('historical-results');
            resultsContainer.innerHTML = '<div class="loading">Analyzing historical data...</div>';

            try {
                const response = await fetch(`/api/historical/${ticker}/${date}`);
                const data = await response.json();
                displayHistoricalData(data);
            } catch (error) {
                resultsContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayHistoricalData(data) {
            const container = document.getElementById('historical-results');
            
            if (data.error) {
                container.innerHTML = `<div class="error">${data.error}</div>`;
                return;
            }

            const morningChangeClass = data.morning_change >= 0 ? 'change-positive' : 'change-negative';
            const closingChangeClass = data.closing_change >= 0 ? 'change-positive' : 'change-negative';

            container.innerHTML = `
                <div class="card result-card">
                    <h3>📊 Historical Analysis Results</h3>
                    <div class="stock-name" style="color: white;">${data.ticker} - ${data.company_name}</div>
                    <div style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${data.sector}</div>
                    
                    <div class="price-info" style="color: white;">
                        <div class="price-section">
                            <h4>Morning Session (${data.morning_date})</h4>
                            <div class="price-value">₹${data.p915} → ₹${data.p919}</div>
                            <div class="${morningChangeClass}">${data.morning_change > 0 ? '+' : ''}${data.morning_change}%</div>
                        </div>
                        <div class="price-section">
                            <h4>Previous Closing (${data.closing_date})</h4>
                            <div class="price-value">₹${data.p315} → ₹${data.p329}</div>
                            <div class="${closingChangeClass}">${data.closing_change > 0 ? '+' : ''}${data.closing_change}%</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Volume Analysis:</strong><br>
                        Morning Volume Change: ${data.morning_volume_change ? (data.morning_volume_change > 0 ? '+' : '') + data.morning_volume_change + '%' : 'N/A'}<br>
                        Closing Volume Change: ${data.closing_volume_change ? (data.closing_volume_change > 0 ? '+' : '') + data.closing_volume_change + '%' : 'N/A'}
                    </div>
                </div>
            `;
        }

        async function executeMockTrade() {
            const ticker = document.getElementById('trade-ticker').value;
            const date = document.getElementById('trade-date').value;
            const time = document.getElementById('trade-time').value;
            const amount = document.getElementById('investment-amount').value;

            if (!date || !time) {
                alert('Please fill in all fields');
                return;
            }

            const resultsContainer = document.getElementById('mock-trade-results');
            resultsContainer.innerHTML = '<div class="loading">Executing mock trade...</div>';

            try {
                const response = await fetch('/api/mock-trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker, date, time, investment_amount: parseInt(amount) })
                });
                
                const data = await response.json();
                displayMockTradeResults(data);
            } catch (error) {
                resultsContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayMockTradeResults(data) {
            const container = document.getElementById('mock-trade-results');
            
            if (data.error) {
                container.innerHTML = `<div class="error">${data.error}</div>`;
                return;
            }

            const profitClass = data.max_profit >= 0 ? 'change-positive' : 'change-negative';
            const returnClass = data.return_percentage >= 0 ? 'change-positive' : 'change-negative';

            container.innerHTML = `
                <div class="card result-card">
                    <h3>💰 Mock Trade Results</h3>
                    <div class="stock-name" style="color: white;">${data.ticker} - ${data.company_name}</div>
                    <div style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${data.sector}</div>
                    
                    <div class="sector-stats" style="color: white;">
                        <div class="stat-item">
                            <span class="stat-value">₹${data.entry_price}</span>
                            <span class="stat-label">Entry Price</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">₹${data.exit_price}</span>
                            <span class="stat-label">Best Exit</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value ${profitClass}">₹${data.max_profit}</span>
                            <span class="stat-label">Max Profit</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value ${returnClass}">${data.return_percentage}%</span>
                            <span class="stat-label">Return %</span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Trade Details:</strong><br>
                        Date: ${data.date} | Entry Time: ${data.entry_time} | Best Exit: ${data.best_exit_time}<br>
                        Investment: ₹${data.investment_amount} | Shares: ${data.shares_bought}
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            `;

            // Create price chart
            createPriceChart(data.minute_prices);
        }

        function createPriceChart(minuteData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: minuteData.map(d => d.time),
                    datasets: [{
                        label: 'Stock Price (₹)',
                        data: minuteData.map(d => d.price),
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Profit (₹)',
                        data: minuteData.map(d => d.profit),
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, title: { display: true, text: 'Price (₹)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Profit (₹)' } },
                        x: { title: { display: true, text: 'Time' } }
                    }
                }
            });
        }

        async function fetchSectorData() {
            const container = document.getElementById('sector-data');
            container.innerHTML = '<div class="loading">Loading sector performance...</div>';

            try {
                const response = await fetch('/api/sectors');
                const data = await response.json();
                displaySectorData(data.sectors);
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displaySectorData(sectors) {
            const container = document.getElementById('sector-data');
            
            container.innerHTML = sectors.map(sector => `
                <div class="card">
                    <h3 style="color: #333; margin-bottom: 15px;">🏢 ${sector.sector}</h3>
                    
                    <div class="sector-stats">
                        <div class="stat-item" style="background: #e8f5e8; color: #2e7d32;">
                            <span class="stat-value">${sector.total_stocks}</span>
                            <span class="stat-label">Total Stocks</span>
                        </div>
                        <div class="stat-item" style="background: #e3f2fd; color: #1976d2;">
                            <span class="stat-value">${sector.morning_gainers}</span>
                            <span class="stat-label">Morning Gainers</span>
                        </div>
                        <div class="stat-item" style="background: #fce4ec; color: #c2185b;">
                            <span class="stat-value">${sector.morning_losers}</span>
                            <span class="stat-label">Morning Losers</span>
                        </div>
                        <div class="stat-item" style="background: #fff3e0; color: #f57c00;">
                            <span class="stat-value">${sector.avg_morning_change}%</span>
                            <span class="stat-label">Avg Change</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('historical-date').max = today;
            document.getElementById('trade-date').max = today;
            
            startLiveUpdates();
        });
    </script>
</body>
</html>
